name: Spring Training HR Prediction

on:
  # Run weekly during spring training (starts March to ensure sufficient data)
  schedule:
    - cron: '0 12 * 2-3 1'  # Every Monday at noon UTC in February and March
  # Allow manual runs
  workflow_dispatch:
    inputs:
      min_pa:
        description: 'Minimum plate appearances to include a player'
        required: false
        default: '10'
      st_end_date:
        description: 'End date for spring training data (YYYY-MM-DD, blank for today)'
        required: false
        default: ''

jobs:
  predict:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.2'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: ${{ env.R_LIBS_USER }}
          key: r-packages-${{ runner.os }}-${{ hashFiles('spring_training_hr_prediction.R') }}
          restore-keys: |
            r-packages-${{ runner.os }}-

      - name: Install R packages
        run: |
          install.packages(c(
            "dplyr", "tidyr", "purrr", "stringr", "lubridate",
            "readr", "tibble", "gbm", "httr", "jsonlite",
            "sabRmetrics"
          ), repos = "https://cloud.r-project.org")
        shell: Rscript {0}

      - name: Create output directories
        run: |
          mkdir -p output cache

      - name: Train the breakout model
        run: Rscript hr_bbe_analysis.R
        shell: bash

      - name: Run spring training HR prediction
        env:
          INPUT_MIN_PA: ${{ github.event.inputs.min_pa }}
          INPUT_ST_END_DATE: ${{ github.event.inputs.st_end_date }}
        run: |
          # Source the script without auto-running (set flag to suppress)
          args_backup <- commandArgs
          commandArgs <- function(trailingOnly = FALSE) if (trailingOnly) "no-auto-run" else args_backup()
          source("spring_training_hr_prediction.R")
          commandArgs <- args_backup

          # Apply overrides from environment variables (avoids eval/parse injection)
          end_date <- Sys.getenv("INPUT_ST_END_DATE", "")
          if (nchar(end_date) > 0) {
            ST_END <<- end_date
          }

          min_pa_str <- Sys.getenv("INPUT_MIN_PA", "10")
          min_pa_val <- suppressWarnings(as.integer(min_pa_str))
          if (!is.na(min_pa_val)) {
            MIN_PA <<- min_pa_val
          }

          predict_spring_hr_gainers(verbose = TRUE)
        shell: Rscript {0}

      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: spring-training-hr-predictions
          path: |
            output/spring_training_hr_prediction_*.csv
            output/spring_training_hr_report_*.md
          retention-days: 90

      - name: Post results summary to job output
        run: |
          # Find the most recent report
          reports <- list.files("output", pattern = "spring_training_hr_report_.*\\.md$",
                                full.names = TRUE)
          if (length(reports) > 0) {
            report <- reports[length(reports)]
            cat("### Spring Training HR Prediction Results\n\n")
            cat(readLines(report), sep = "\n")
          } else {
            cat("No report generated.\n")
          }
        shell: Rscript {0}

      - name: Write job summary
        run: |
          REPORT=$(ls -t output/spring_training_hr_report_*.md 2>/dev/null | head -1)
          if [ -n "$REPORT" ]; then
            cat "$REPORT" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No report generated." >> "$GITHUB_STEP_SUMMARY"
          fi
